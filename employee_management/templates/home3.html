<!-- Main Content -->
<div class="main-content container mt-5">
    {% if user.is_authenticated %}
        <h1 class="text-white mb-4">Tickets Overview</h1>
        {% for user_tickets in tickets_by_user %}
            <div class="card mb-3 ticket-card">
                <!-- Name Bar (click to expand older tickets) -->
                <div class="card-header ticket-header">
                    <h3 class="m-0" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapse-{{ user_tickets.user.id }}" aria-expanded="false" aria-controls="collapse-{{ user_tickets.user.id }}">
                        {{ user_tickets.user.username }}'s Tickets
                    </h3>
                </div>

                <!-- Latest Ticket is always shown -->
                <div class="card-body ticket-body">
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Expand</th>
                                <th>Ticket ID</th>
                                <th>Subject</th>
                                <th>Status</th>
                                <th>Assigned By</th>
                                <th>Agent</th>
                                <th>Assign Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Latest Ticket (always shown) -->
                            {% if user_tickets.latest_ticket %}
                                <tr>
                                    <td>
                                        <!-- Plus Button for Latest Ticket -->
                                        <button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#options-{{ user_tickets.latest_ticket.id }}" aria-expanded="false" aria-controls="options-{{ user_tickets.latest_ticket.id }}">
                                            +
                                        </button>
                                    </td>
                                    <td>{{ user_tickets.latest_ticket.id }}</td>
                                    <td>{{ user_tickets.latest_ticket.subject }}</td>
                                    <td>{{ user_tickets.latest_ticket.status }}</td>
                                    <td>{{ user_tickets.latest_ticket.assigned_by.username }}</td>
                                    <td>{{ user_tickets.latest_ticket.assigned_to.username|default:"Unassigned" }}</td>
                                    <td>{{ user_tickets.latest_ticket.created_at|date:"Y-m-d H:i:s" }}</td>
                                </tr>

                                <!-- Options for Latest Ticket (collapsed by plus button) -->
                                <tr>
                                    <td colspan="7">
                                        <div class="collapse mt-2" id="options-{{ user_tickets.latest_ticket.id }}">
                                            <div class="options-list d-flex justify-content-start">
                                                <a class="btn btn-outline-primary me-2" href="{% url 'assign_ticket' user_tickets.latest_ticket.id %}">Assign</a>
                                                <a class="btn btn-outline-warning me-2" href="{% url 'edit_ticket' user_tickets.latest_ticket.id %}">Edit</a>
                                                <a class="btn btn-outline-danger" href="{% url 'delete_ticket' user_tickets.latest_ticket.id %}">Delete</a>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}

                            <!-- Older Tickets (hidden until the name bar is clicked) -->
                            {% if user_tickets.older_tickets %}
                                {% for ticket in user_tickets.older_tickets %}
                                    <tr class="collapse table-collapse" id="collapse-{{ user_tickets.user.id }}">
                                        <td>
                                            <!-- Plus Button for Older Tickets -->
                                            <button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#options-{{ ticket.id }}" aria-expanded="false" aria-controls="options-{{ ticket.id }}">
                                                +
                                            </button>
                                        </td>
                                        <td>{{ ticket.id }}</td>
                                        <td>{{ ticket.subject }}</td>
                                        <td>{{ ticket.status }}</td>
                                        <td>{{ ticket.assigned_by.username|default:"N/A" }}</td>
                                        <td>{{ ticket.assigned_to.username|default:"Unassigned" }}</td>
                                        <td>{{ ticket.created_at|date:"Y-m-d H:i:s" }}</td>
                                    </tr>

                                    <!-- Options for Older Tickets (collapsed by plus button) -->
                                    <tr class="collapse table-collapse" id="options-{{ ticket.id }}">
                                        <td colspan="7">
                                            <div class="options-list d-flex justify-content-start">
                                                <a class="btn btn-outline-primary me-2" href="{% url 'assign_ticket' ticket.id %}">Assign</a>
                                                <a class="btn btn-outline-warning me-2" href="{% url 'edit_ticket' ticket.id %}">Edit</a>
                                                <a class="btn btn-outline-danger" href="{% url 'delete_ticket' ticket.id %}">Delete</a>
                                            </div>

                                    </td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p class="text-white">You need to be logged in to view tickets.</p>
    {% endif %}
</div>